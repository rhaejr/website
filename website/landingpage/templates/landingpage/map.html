{% load staticfiles %}
{% block content %}
<meta charset="utf-8">
<style>
    .counties :hover {
        fill: red;
    }
    .counties {
        fill: none;
    }
    .county-borders {
        fill: none;
        stroke: #fff;
        stroke-width: 0.5px;
        stroke-linejoin: round;
        stroke-linecap: round;
        pointer-events: none;
    }
</style>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script>
    var count_color = {};
    var pay = d3.map();
    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var path = d3.geoPath();
    var x = d3.scaleLinear()
        .domain([1, 10])
        .rangeRound([600, 860]);

    svg.append("rect")
        .attr("class", "background")
        .attr("fill", '#D3D3D3')
        .attr("width", width)
        .attr("height", height);

    var thresholds = [22, 23, 24, 25, 26, 27, 28, 29, 30];
    var color = d3.scaleThreshold()
        .domain(thresholds)
        .range(d3.schemeGreens[9]);

        var legend = svg.selectAll("g.legend")
        .data(thresholds)
        .enter().append("g")
        .attr("class", "legend");
      
        var ls_w = 20, ls_h = 20;
      
        legend.append("rect")
        .attr("x", 850)
        .attr("y", function(d, i){ return height - (i*ls_h) - 2*ls_h;})
        .attr("width", ls_w)
        .attr("height", ls_h)
        .style("fill", function(d, i) { return color(d); })
        .style("opacity", 0.8);
      
        legend.append("text")
        .attr("x", 849)
        .attr("y", function(d, i){ return height - (i*ls_h) - ls_h - 3;})
        .text(function(d, i){ return '____$' + thresholds[i]; }); 
    
    d3.queue()
        .defer(d3.json, "{% static '/data/us-10m.v2.json' %}")
        .defer(d3.csv, "{% static '/data/2016.csv' %}", function (d) {
            pay.set(add_zero(d.id), +d.rate);
        })
        .await(ready);

    function ready(error, us) {
        if (error) throw error;

        svg.append("g")
            .attr("class", "counties")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.counties).features)
            .enter().append("path")
            .attr("fill", function (d) {
                c = color(d.rate = pay.get(d.id))
                if (count_color[c]) {
                    count_color[c]++;
                } else {
                    count_color[c] = 1;
                }

                return c;
            })
            .attr("d", path)
            .append("title")
            .text(function (d) {
                return '$' + d.rate;
            });
        svg.append("g")
            .attr("class", "counties")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.counties).features)
            .enter().append("path")
            .attr("d", path);

        svg.append("path")
            .attr("class", "county-borders")
            .attr("d", path(topojson.mesh(us, us.objects.counties, function (a, b) {
                return a !== b;
            })));

        svg.append("text")
            .attr("class", "caption")
            .attr("x", 500)
            .attr("y", 18)
            .attr("fill", "#000")
            .attr("text-anchor", "start")
            .attr("font-weight", "bold")
            .text("Federal Wage Grade Pay 2016");

        svg.append("text")
            .attr("class", "caption")
            .attr("x", 500)
            .attr("y", 32)
            .attr("fill", "#000")
            .attr("text-anchor", "start")
            .text("Based on WG-10 top pay, by county");

        svg.append("text")
            .attr("class", "caption")
            .attr("x", 500)
            .attr("y", 46)
            .attr("fill", "#000")
            .attr("text-anchor", "start")
            .text("Colored by pay rate above set thresholds");

    }
    /*d3.json("{% static '/data/us-10m.v2.json' %}", function(error, us) {
      if (error) throw error;
    
     
    });*/
    function add_zero(id){
        if (id.length == 4){
          return '0'+ id;
        }
        return id;
      };
</script>
{% endblock %}